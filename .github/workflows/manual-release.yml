name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.2.0)'
        required: true
      notes:
        description: 'Release notes'
        required: false

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gh
        uses: cli/cli@v2

      - name: Find last successful build run
        id: run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RUN_ID=$(gh api repos/${{ github.repository }}/actions/workflows/build.yml/runs \
            --jq '.workflow_runs[] | select(.conclusion=="success") | .id' | head -n 1)

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download app-linux artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/actions/runs/${{ steps.run.outputs.run_id }}/artifacts \
            --jq '.artifacts[] | select(.name=="app-linux") | .archive_download_url' \
            | xargs -n1 gh api > app-linux.zip

          unzip app-linux.zip -d dist/linux

      - name: Download app-windows artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/actions/runs/${{ steps.run.outputs.run_id }}/artifacts \
            --jq '.artifacts[] | select(.name=="app-windows") | .archive_download_url' \
            | xargs -n1 gh api > app-windows.zip

          unzip app-windows.zip -d dist/windows

      - name: Prepare release folder
        run: |
          mkdir release
          cp dist/linux/* release/
          cp dist/windows/* release/

          chmod +x release/app-linux || true
          chmod +x release/update-helper || true

          mv release/app-linux release/HyLauncher-linux-x64
          mv release/app-windows.exe release/HyLauncher-windows-x64.exe

      - name: Generate version.json
        run: |
          VERSION="${{ inputs.version }}"
          LINUX_SHA=$(sha256sum release/HyLauncher-linux-x64 | cut -d ' ' -f1)
          WINDOWS_SHA=$(sha256sum release/HyLauncher-windows-x64.exe | cut -d ' ' -f1)

          cat <<EOF > release/version.json
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-linux-x64",
                "sha256": "$LINUX_SHA"
              }
            },
            "windows": {
              "amd64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-windows-x64.exe",
                "sha256": "$WINDOWS_SHA"
              }
            }
          }
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: ${{ inputs.notes }}
          files: |
            release/HyLauncher-linux-x64
            release/HyLauncher-windows-x64.exe
            release/update-helper*
            release/version.json
