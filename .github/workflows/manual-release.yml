name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.2.0)"
        required: true
      notes:
        description: "Optional release notes"
        required: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for tags & changelog

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Linux deps
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential pkg-config \
            libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.0-dev

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build update-helper
        run: |
          mkdir -p release
          GOOS=linux GOARCH=amd64 go build -o release/update-helper-linux ./cmd/update-helper
          GOOS=windows GOARCH=amd64 go build -o release/update-helper-windows.exe ./cmd/update-helper

      - name: Build HyLauncher
        run: |
          mkdir -p release

          # Linux portable
          wails build -platform linux/amd64
          cp build/bin/HyLauncher release/HyLauncher-linux-x64
          chmod +x release/HyLauncher-linux-x64

          # Portable windows
          CGO_ENABLED=0 wails build -platform windows/amd64
          cp build/bin/HyLauncher.exe release/HyLauncher-windows-x64-portable.exe

          # NSIS Installer
          CGO_ENABLED=0 wails build -platform windows/amd64 -nsis
          cp build/bin/HyLauncher-amd64-installer.exe \
             release/HyLauncher-setup-windows-x64.exe

      - name: Generate version.json
        run: |
          VERSION="${{ inputs.version }}"

          LINUX_LAUNCHER_SHA=$(sha256sum release/HyLauncher-linux-x64 | cut -d' ' -f1)
          LINUX_HELPER_SHA=$(sha256sum release/update-helper-linux | cut -d' ' -f1)

          WINDOWS_LAUNCHER_SHA=$(sha256sum release/HyLauncher-windows-x64-portable.exe | cut -d' ' -f1)
          WINDOWS_HELPER_SHA=$(sha256sum release/update-helper-windows.exe | cut -d' ' -f1)

          cat <<EOF > release/version.json
          {
            "version": "$VERSION",
            "linux": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-linux-x64",
                  "sha256": "$LINUX_LAUNCHER_SHA"
                },
                "helper": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/update-helper-linux",
                  "sha256": "$LINUX_HELPER_SHA"
                }
              }
            },
            "windows": {
              "amd64": {
                "launcher": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/HyLauncher-windows-x64-portable.exe",
                  "sha256": "$WINDOWS_LAUNCHER_SHA"
                },
                "helper": {
                  "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/update-helper-windows.exe",
                  "sha256": "$WINDOWS_HELPER_SHA"
                }
              }
            }
          }
          EOF

      - name: Generate changelog
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREV_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')

          if [ -z "$PREV_TAG" ]; then
            echo "Initial release" > changelog.txt
          else
            git log "$PREV_TAG"..HEAD \
              --pretty=format:"- %s (%h)" > changelog.txt
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body_path: changelog.txt
          files: |
            release/*

  cleanup:
    name: Cleanup old artifacts
    needs: release
    if: success()
    runs-on: ubuntu-latest

    permissions:
      actions: write

    steps:
      - name: Delete artifacts from previous runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Fetching artifactsâ€¦"

          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq '.artifacts[] | select(.workflow_run.id != '${{ github.run_id }}') | .id')

          if [ -z "$ARTIFACTS" ]; then
            echo "No old artifacts found."
            exit 0
          fi

          for id in $ARTIFACTS; do
            echo "Deleting artifact ID: $id"
            gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$id
          done
